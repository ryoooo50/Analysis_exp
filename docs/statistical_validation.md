# 統計検定ロジック検証メモ

本アプリで提供している各検定について、実装の計算ロジックと信頼性担保の観点で確認した内容をまとめる。
実装はすべて `utils/statistical_tests.py`（一部 `app.py`）に集約されている。

---

## 共通の前処理・ユーティリティ
- **Shapiro-Wilk 正規性検定**  
  - `run_shapiro()` で SciPy `shapiro()` を呼び出し、各グループの正規性を確認。
  - サンプル数が 3 未満の場合は検定できないため `{stat: 0, p: 0}` を返す防御ロジックあり。
- **効果量 r の算出**  
  - `calculate_z_and_r_from_p()` でノンパラメトリック検定の z 値・効果量 r を計算。  
  - SciPy が返す p 値から正規分布の逆累積（`norm.ppf`）を利用して算出。
- **Holm-Bonferroni 補正**  
  - `apply_holm_correction()` が p 値リストに対して Holm 法を適用。  
  - ソート → 逐次的な補正値の上限調整（単調性の担保）まで実装済み。

---

## 1. マン・ホイットニー U 検定
- 実装箇所: `perform_mannwhitney_test()`  
- 使用ライブラリ: `scipy.stats.mannwhitneyu`  
- 補足処理:
  - p 値から z 値と効果量 r（`Z/√N`）を計算。
  - グループ合計サンプル数を N とし、Holm 補正に備えて数値を返却。
- 信頼性:
  - SciPy の実装は広く検証済み。  
  - 本アプリ側では、文字列入力 → 数値リスト化 → SciPy 呼び出しという流れで、追加の独自演算は効果量のみ。

## 2. ウィルコクソン符号順位検定
- 実装箇所: `perform_wilcoxon_test()`  
- 使用ライブラリ: `scipy.stats.wilcoxon`  
- 補足処理:
  - 対応のあるデータのみ許可（サンプル数 mismatch で例外）。  
  - 効果量 r を `Z/√(2n)` 相当の式で算出（ペア数を基礎に N_total_obs = 2n としている）。
- 信頼性:
  - SciPy のアルゴリズムに準拠。  
  - 入力バリデーションと効果量計算のみ独自実装。

## 3. t 検定（対応のない 2 群）
- 実装箇所: `perform_ttest()`  
- 使用ライブラリ:
  - `scipy.stats.ttest_ind`  
  - `scipy.stats.levene`（等分散性チェック）  
  - `scipy.stats.shapiro`（正規性チェック）
- 補足処理:
  - 正規性が満たされない場合は警告メッセージを返す。  
  - 等分散性に応じて `equal_var` を切り替え（Welch の t 検定への自動切り替え）。  
  - 効果量として Cohen’s d と効果量 r を併記。  
  - 自由度 df を等分散・不等分散で分岐計算。
- 信頼性:
  - 検定本体は SciPy 依存。  
  - 効果量・df 計算は統計公式に沿った実装（ゼロ除算などの防御を含む）。

## 4. 分散分析（ANOVA / Kruskal-Wallis）
- 実装箇所: `perform_oneway_anova_or_kruskal()`  
- 使用ライブラリ:
  - `scipy.stats.f_oneway`（一元配置分散分析）
  - `scipy.stats.kruskal`（クラスカル・ウォリス検定）
  - `scipy.stats.levene`（等分散性）
- 判定ロジック:
  1. 各グループで Shapiro-Wilk の結果が有意でないかを確認（正規性）。  
  2. 全グループで正規性が満たされ、かつ Levene 検定で等分散性が確認できた場合 → ANOVA。  
  3. それ以外 → Kruskal-Wallis 検定。
- 効果量:
  - ANOVA: η²（イータ二乗）  
  - Kruskal-Wallis: ε²（イプシロン二乗）
- 信頼性:
  - SciPy の検定関数をそのまま利用。  
  - 効果量算出に用いる式も標準的なものを使用（分散分析の SS から η² を算出、Kruskal-Wallis の H 統計量から ε² を算出）。

## 5. 多重比較補正
- `apply_holm_correction()` が複数の検定結果に一括適用可能。  
- UI では任意テストセットを JSON にまとめて `/analyze-multiple-tests` に送信 → Holm 補正後の p 値と有意判定を返却。
- 検定結果には補正後 p 値 (`adjusted_p_value`) と有意判定 (`significant_after_correction`) を付加。

---

## 実装上の信頼性確保のポイント
1. **信頼性の高いライブラリを利用**  
   - すべての統計検定は SciPy に委譲し、基礎計算を自作していない。
2. **入力データのバリデーション**  
   - 必須データの欠如・サンプル数不足・文字列変換エラーを明示的に検出。  
   - グループ数やデータ数が条件を満たさない場合は 400 エラーで応答。
3. **正規性・等分散性・効果量のレポート**  
   - 結果 JSON に検定前提の成否や効果量を含め、UI で可視化。  
   - ノンパラメトリック検定への切り替え方針が明示されるため、結果の解釈が透明。
4. **多重検定への配慮**  
   - Holm 補正パネルを用意し、複数の検定結果と補正後の有意判定を一元的に確認できる。
5. **ユニット互換性**  
   - すべて数値計算は NumPy／SciPy の配列演算を利用し、浮動小数の NaN/inf を `_safe_float()` で処理。

---

## 補足
- コード全体の構文チェック（`python -m py_compile ...`）で実行時エラーが発生しないことを確認済み。  
- 独自ロジックはデータ整形・効果量算出・結果整形に限定され、検定そのものは SciPy の実装を利用。  
- UI 側のタブ（`templates/index.html`）でも正規性・等分散性・効果量などの情報が表示されるようになっており、ユーザー自身が結果の妥当性を判断しやすい設計になっている。

