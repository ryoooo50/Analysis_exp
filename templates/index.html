<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リーチング分析・統計アプリ</title>
    <style>
        :root {
            --primary-color: #007bff; --light-gray: #f8f9fa; --gray: #6c757d;
            --border-color: #dee2e6; --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --danger-color: #dc3545; --success-color: #28a745;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--light-gray);
            color: #333;
            margin: 0;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto 2rem auto;
        }
        footer {
            width: 100%;
            max-width: 900px;
        }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 2rem; }
        h1, h2, h3, h4 { color: #333; }
        h1 { color: var(--primary-color); text-align: center; }
        p { text-align: center; color: var(--gray); }
        .tab-buttons { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; }
        .tab-button { padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-size: 1.1rem; font-weight: 500; color: var(--gray); border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .upload-area { border: 2px dashed var(--primary-color); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .upload-area.drag-over { background-color: #e9f5ff; }
        #file-input-peak { display: none; }
        .file-name { margin-top: 1rem; font-weight: bold; color: var(--primary-color); }
        .params-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1rem; }
        .param-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .param-group input, .param-group select { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
        
        /* --- テキストエリアのスタイル --- */
        .param-group textarea {
            width: 100%;
            height: 150px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: var(--font-family);
            font-size: 0.9rem;
        }

        button[type="submit"] { width: 100%; padding: 0.75rem; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button[type="submit"]:hover { background-color: #0056b3; }
        .results { display: none; }
        .spinner { display: none; margin: 2rem auto; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-summary { text-align: center; margin-bottom: 2rem; }
        .result-summary .peak-count { font-size: 3rem; font-weight: bold; color: var(--primary-color); }
        #plot-container img { max-width: 100%; border-radius: 4px; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--border-color); padding: 0.75rem; text-align: left; }
        th { background-color: var(--light-gray); }
        .form-group-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        /* --- [新規追加] 統計結果のスタイル --- */
        .test-result-block {
            background-color: #fdfdfd;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .test-result-block h4 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .significant {
            color: var(--success-color);
            font-weight: bold;
            font-size: 1.1rem;
        }
        .not-significant {
            color: var(--danger-color);
            font-weight: bold;
            font-size: 1.1rem;
        }
        .muted {
            color: var(--gray);
            font-size: 0.9rem;
        }
        .toggle-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        .multiple-settings {
            display: none;
            margin-top: 1.5rem;
        }
        .btn-secondary {
            padding: 0.5rem 1rem;
            background-color: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #e2e6ea;
        }
        .multiple-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .multiple-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .multiple-form-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        .multiple-form-block {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            background: #fff;
        }
        .multiple-form-block h5 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
        }
        footer {
            margin-top: 3rem;
            padding: 1.5rem;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        footer h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .legal-notice p,
        .legal-notice ul {
            font-size: 0.9rem;
            color: var(--gray);
            line-height: 1.6;
        }
        .legal-notice ul {
            padding-left: 1.25rem;
            margin-top: 0.5rem;
        }
        .legal-notice li {
            margin-bottom: 0.4rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>リーチング分析・統計アプリ</h1>
            <p>分析したいタスクをタブで選択してください。</p>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" data-tab="tab-mw">マン・ホイットニーU検定</button>
            <button class="tab-button" data-tab="tab-wilcoxon">ウィルコクソン順位符号付検定</button>
            <button class="tab-button" data-tab="tab-ttest">t検定</button>
            <button class="tab-button" data-tab="tab-peak">ピーク分析</button>
        </div>

        <div id="tab-mw" class="tab-content active">
            <div class="card">
                <form id="form-mw">
                    <p>対応のない2群間 (Group 1 vs Group 2) のノンパラメトリック検定を行います。</p>
                    <div class="form-group-grid">
                        <div class="param-group">
                            <label for="mw-data1"><b>Group 1</b> のデータ (カンマ区切り)</label>
                            <textarea id="mw-data1" placeholder="4.1, 4.4, 4.2, ..."></textarea>
                        </div>
                        <div class="param-group">
                            <label for="mw-data2"><b>Group 2</b> のデータ (カンマ区切り)</label>
                            <textarea id="mw-data2" placeholder="3.5, 3.4, 3.2, ..."></textarea>
                        </div>
                    </div>
                    <br>
                    <div class="param-group">
                        <label for="mw-alternative">検定の種類 (仮説)</label>
                        <select id="mw-alternative">
                            <option value="two-sided">両側検定 (Group 1 ≠ Group 2)</option>
                            <option value="less">片側検定 (Group 1 < Group 2)</option>
                            <option value="greater">片側検定 (Group 1 > Group 2)</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label for="mw-alpha">有意水準 (α)</label>
                        <input type="number" id="mw-alpha" step="0.001" min="0" max="1" value="0.05">
                    </div>
                    <br>
                    <button type="submit">検定開始</button>
                    <div class="multiple-section">
                        <label class="toggle-label">
                            <input type="checkbox" id="mw-multiple-enable">
                            Holm法による多重検定を実行する
                        </label>
                        <div id="mw-multiple-controls" class="multiple-settings">
                            <div class="params-grid">
                                <div class="param-group">
                                    <label for="mw-multiple-count">多重度 (検定回数)</label>
                                    <input type="number" id="mw-multiple-count" step="1" min="1" value="1">
                                </div>
                            </div>
                            <div class="multiple-buttons">
                                <button type="button" id="mw-multiple-copy" class="btn-secondary">現在の入力を1件目にコピー</button>
                                <button type="button" id="mw-multiple-run">Holm補正を実行</button>
                            </div>
                            <div id="mw-multiple-form-container" class="multiple-form-list"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div id="spinner-mw" class="spinner"></div>
            <div id="results-mw" class="card results">
                <h2>検定結果 (Mann-Whitney U Test)</h2>
                <div id="result-text-mw"></div>
                <div id="result-text-mw-multiple"></div>
            </div>
        </div>

        <div id="tab-wilcoxon" class="tab-content">
            <div class="card">
                <form id="form-wilcoxon">
                    <p>対応のある2群間 (Before vs After) のノンパラメトリック検定を行います。</p>
                    <div class="form-group-grid">
                        <div class="param-group">
                            <label for="wilcoxon-data1"><b>Group 1 (例: Before)</b> (カンマ区切り)</label>
                            <textarea id="wilcoxon-data1" placeholder="4.1, 4.4, 4.2, ..."></textarea>
                        </div>
                        <div class="param-group">
                            <label for="wilcoxon-data2"><b>Group 2 (例: After)</b> (カンマ区切り)</label>
                            <textarea id="wilcoxon-data2" placeholder="3.5, 3.4, 3.2, ..."></textarea>
                        </div>
                    </div>
                    <br>
                    <div class="param-group">
                        <label for="wilcoxon-alternative">検定の種類 (仮説)</label>
                        <select id="wilcoxon-alternative">
                            <option value="two-sided">両側検定 (Group 1 ≠ Group 2)</option>
                            <option value="less">片側検定 (Group 1 < Group 2)</option>
                            <option value="greater">片側検定 (Group 1 > Group 2)</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label for="wilcoxon-alpha">有意水準 (α)</label>
                        <input type="number" id="wilcoxon-alpha" step="0.001" min="0" max="1" value="0.05">
                    </div>
                    <br>
                    <button type="submit">検定開始</button>
                    <div class="multiple-section">
                        <label class="toggle-label">
                            <input type="checkbox" id="wilcoxon-multiple-enable">
                            Holm法による多重検定を実行する
                        </label>
                        <div id="wilcoxon-multiple-controls" class="multiple-settings">
                            <div class="params-grid">
                                <div class="param-group">
                                    <label for="wilcoxon-multiple-count">多重度 (検定回数)</label>
                                    <input type="number" id="wilcoxon-multiple-count" step="1" min="1" value="1">
                                </div>
                            </div>
                            <div class="multiple-buttons">
                                <button type="button" id="wilcoxon-multiple-copy" class="btn-secondary">現在の入力を1件目にコピー</button>
                                <button type="button" id="wilcoxon-multiple-run">Holm補正を実行</button>
                            </div>
                            <div id="wilcoxon-multiple-form-container" class="multiple-form-list"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div id="spinner-wilcoxon" class="spinner"></div>
            <div id="results-wilcoxon" class="card results">
                <h2>検定結果 (Wilcoxon Signed-Rank Test)</h2>
                <div id="result-text-wilcoxon"></div>
                <div id="result-text-wilcoxon-multiple"></div>
            </div>
        </div>

        <div id="tab-ttest" class="tab-content">
            <div class="card">
                <form id="form-ttest">
                    <p>対応のないのt検定を行います。</p>
                    <div class="form-group-grid">
                        <div class="param-group">
                            <label for="ttest-data1"><b>Group 1 (例：Before)</b>(カンマ区切り)</label>
                            <textarea id="ttest-data1" placeholder="4.1, 4.4, 4.2, ..."></textarea>
                        </div>
                        <div class="param-group">
                            <label for="ttest-data2"><b>Group 2 (例: After)</b> (カンマ区切り)</label>
                            <textarea id="ttest-data2" placeholder="3.5, 3.4, 3.2, ..."></textarea>
                        </div>
                    </div>
                    <br>
                    <div class="param-group">
                        <label for="ttest-alternative">検定の種類 (仮説)</label>
                        <select id="ttest-alternative">
                            <option value="two-sided">両側検定 (Group 1 ≠ Group 2)</option>
                            <option value="less">片側検定 (Group 1 < Group 2)</option>
                            <option value="greater">片側検定 (Group 1 > Group 2)</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label for="ttest-alpha">有意水準 (α)</label>
                        <input type="number" id="ttest-alpha" step="0.001" min="0" max="1" value="0.05">
                    </div>
                    <br>
                    <button type="submit">検定開始</button>
                    <div class="multiple-section">
                        <label class="toggle-label">
                            <input type="checkbox" id="ttest-multiple-enable">
                            Holm法による多重検定を実行する
                        </label>
                        <div id="ttest-multiple-controls" class="multiple-settings">
                            <div class="params-grid">
                                <div class="param-group">
                                    <label for="ttest-multiple-count">多重度 (検定回数)</label>
                                    <input type="number" id="ttest-multiple-count" step="1" min="1" value="1">
                                </div>
                            </div>
                            <div class="multiple-buttons">
                                <button type="button" id="ttest-multiple-copy" class="btn-secondary">現在の入力を1件目にコピー</button>
                                <button type="button" id="ttest-multiple-run">Holm補正を実行</button>
                            </div>
                            <div id="ttest-multiple-form-container" class="multiple-form-list"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div id="spinner-ttest" class="spinner"></div>
            <div id="results-ttest" class="card results">
                <h2>検定結果 (t-test)</h2>
                <div id="result-text-ttest"></div>
                <div id="result-text-ttest-multiple"></div>
            </div>
        </div>

        <div id="tab-peak" class="tab-content">
            <div class="card">
                <form id="form-peak">
                    <div id="upload-area-peak" class="upload-area">
                        <input type="file" id="file-input-peak" accept=".csv">
                        <p>ここにCSVファイルをドラッグ＆ドロップ<br>またはクリックしてファイルを選択</p>
                        <div id="file-name-peak" class="file-name"></div>
                    </div>
                    <h3>ピーク検出パラメータ</h3>
                    <div class="params-grid">
                        <div class="param-group">
                            <label for="min_peak_height">最小高さ (rad/s)</label>
                            <input type="number" id="min_peak_height" value="1.0" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="max_peak_height">最大高さ (rad/s)</label>
                            <input type="number" id="max_peak_height" value="100.0" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="peak_prominence">顕著さ</label>
                            <input type="number" id="peak_prominence" value="1.0" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="peak_distance">最小距離 (点)</label>
                            <input type="number" id="peak_distance" value="50" step="1">
                        </div>
                    </div>
                    <br>
                    <button type="submit">分析開始</button>
                </form>
            </div>
            <div id="spinner-peak" class="spinner"></div>
            <div id="results-peak" class="card results">
                <h2>分析結果 (Peak Analysis)</h2>
                <div class="result-summary">
                    <h3>検出されたピーク数</h3>
                    <div id="peak-count" class="peak-count">0</div>
                </div>
                <div id="plot-container"></div>
                <div class="results-grid">
                    <div id="averages-container"></div>
                    <div id="table-container"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="legal-notice">
        <h3>免責事項・データポリシー</h3>
        <p>
            本アプリケーションは研究・教育用途を想定した補助ツールです。提供する解析結果の正確性・完全性・有用性について、開発者は一切保証いたしません。結果の解釈および意思決定は、利用者ご自身の責任と専門的判断で行ってください。
        </p>
        <ul>
            <li>本アプリケーションの利用により生じたいかなる損害・不利益についても、開発者は一切の責任を負いません。</li>
            <li>アップロードされたデータは解析処理にのみ利用され、サーバー上に保存されません。セッション終了後は破棄されます。</li>
            <li>機密性の高いデータを扱う場合は、事前に十分な確認と安全管理を行ってください。</li>
        </ul>
        <p>
            Flask, Pandas, NumPy, SciPy, Matplotlib, Seaborn などの OSS ライブラリは、各プロジェクトのライセンス（MIT / BSD 等）に従って利用しています。
        </p>
    </footer>

    <script>
        // --- [新規追加] エラー回避のための安全な数値フォーマット関数 ---
        /**
         * 数値を安全にフォーマットします (undefined, null, NaN, Infinity を "N/A" にします)。
         * これで .toFixed() エラーを防ぎます。
         * @param {*} value - フォーマットする値
         * @param {number} digits - 小数点以下の桁数
         * @returns {string} - フォーマットされた文字列
         */
        function formatNumber(value, digits = 3) {
            // 値が数値型(number)であり、かつ有限(finite)であるかチェック
            if (typeof value === 'number' && isFinite(value)) {
                return value.toFixed(digits);
            }
            // その他の無効な値 (undefined, null, NaN, Infinity, -Infinity)
            return "N/A";
        }

        function renderSignificanceMessage(alpha, isSignificant) {
            const alphaText = `α=${formatNumber(alpha, 3)}`;
            return isSignificant
                ? `<p class="significant">${alphaText}で統計的に有意な差が見られます。</p>`
                : `<p class="not-significant">${alphaText}で統計的に有意な差は見られません。</p>`;
        }

        // --- タブ切り替えロジック (変更なし) ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // --- ピーク分析タブのUIロジック (変更なし) ---
        function setupUploadArea(uploadAreaId, fileInputId, fileNameId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameId);
            if (!uploadArea) return; 
            
            uploadArea.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}, false));
            ['dragenter', 'dragover'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false));
            ['dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false));
            uploadArea.addEventListener('drop', (e) => {
                fileInput.files = e.dataTransfer.files;
                updateFileName(fileInput, fileNameDisplay);
            }, false);
            fileInput.addEventListener('change', () => updateFileName(fileInput, fileNameDisplay));
        }
        function updateFileName(fileInput, fileNameDisplay) {
            fileNameDisplay.textContent = fileInput.files.length > 0 ? `選択中: ${fileInput.files[0].name}` : '';
        }
        setupUploadArea('upload-area-peak', 'file-input-peak', 'file-name-peak');

        // --- フォーム送信ロジック ---
        // 1. ピーク分析フォーム (変更なし)
        const formPeak = document.getElementById('form-peak');
        const fileInputPeak = document.getElementById('file-input-peak');
        const spinnerPeak = document.getElementById('spinner-peak');
        const resultsPeak = document.getElementById('results-peak');

        formPeak.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (fileInputPeak.files.length === 0) { alert('ファイルを選択してください。'); return; }
            spinnerPeak.style.display = 'block';
            resultsPeak.style.display = 'none';

            const formData = new FormData();
            formData.append('file', fileInputPeak.files[0]);
            formData.append('min_peak_height', document.getElementById('min_peak_height').value);
            formData.append('max_peak_height', document.getElementById('max_peak_height').value);
            formData.append('peak_prominence', document.getElementById('peak_prominence').value);
            formData.append('peak_distance', document.getElementById('peak_distance').value);

            try {
                const response = await fetch('/analyze-peak', { method: 'POST', body: formData });
                const results = await response.json();
                if (!response.ok) throw new Error(results.error || 'サーバーエラー');
                
                document.getElementById('plot-container').innerHTML = '';
                document.getElementById('averages-container').innerHTML = '';
                document.getElementById('table-container').innerHTML = '';
                document.getElementById('peak-count').textContent = results.peak_count;

                const img = document.createElement('img');
                img.src = `data:image/png;base64,${results.image}`;
                document.getElementById('plot-container').appendChild(img);
                
                if (results.peak_averages && results.peak_averages.length > 0) {
                    const h4 = document.createElement('h4'); h4.textContent = '10回ごとの平均';
                    document.getElementById('averages-container').appendChild(h4);
                    const avgTable = document.createElement('table');
                    let avgThead = '<thead><tr><th>区間</th><th>平均角速度 (rad/s)</th></tr></thead>';
                    let avgTbody = '<tbody>';
                    results.peak_averages.forEach(avg => { avgTbody += `<tr><td>${avg.interval}</td><td>${formatNumber(avg.average_velocity, 3)}</td></tr>`; });
                    avgTbody += '</tbody>'; avgTable.innerHTML = avgThead + avgTbody;
                    document.getElementById('averages-container').appendChild(avgTable);
                }
                if (results.peaks && results.peaks.length > 0) {
                    const h4 = document.createElement('h4'); h4.textContent = '全ピーク詳細';
                    document.getElementById('table-container').appendChild(h4);
                    const table = document.createElement('table');
                    let thead = '<thead><tr><th>ピーク時間 (s)</th><th>ピーク角速度 (rad/s)</th></tr></thead>';
                    let tbody = '<tbody>';
                    results.peaks.forEach(peak => { tbody += `<tr><td>${formatNumber(peak.peak_time_s, 3)}</td><td>${formatNumber(peak.peak_velocity_rad_s, 3)}</td></tr>`; });
                    tbody += '</tbody>'; table.innerHTML = thead + tbody;
                    document.getElementById('table-container').appendChild(table);
                }
                resultsPeak.style.display = 'block';
            } catch (error) {
                alert(`エラー: ${error.message}`);
            } finally {
                spinnerPeak.style.display = 'none';
            }
        });

        // 2. マン・ホイットニーU検定フォーム [修正]
        const formMw = document.getElementById('form-mw');
        const spinnerMw = document.getElementById('spinner-mw');
        const resultsMw = document.getElementById('results-mw');
        const resultTextMw = document.getElementById('result-text-mw');
        const alphaMwInput = document.getElementById('mw-alpha');

        formMw.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data1 = document.getElementById('mw-data1').value;
            const data2 = document.getElementById('mw-data2').value;
            if (data1.trim() === '' || data2.trim() === '') { alert('2つのグループ両方にデータを入力してください。'); return; }
            spinnerMw.style.display = 'block';
            resultsMw.style.display = 'none';

            const formData = new FormData();
            formData.append('data1', data1);
            formData.append('data2', data2);
            formData.append('alternative', document.getElementById('mw-alternative').value);
            formData.append('alpha', alphaMwInput ? alphaMwInput.value || '0.05' : '0.05');

            try {
                const response = await fetch('/analyze-mann-whitney', { method: 'POST', body: formData });
                const results = await response.json();
                if (!response.ok) throw new Error(results.error || 'サーバーエラー');

                const alphaVal = typeof results.alpha === 'number' ? results.alpha : parseFloat(alphaMwInput?.value || '0.05') || 0.05;
                const isSignificant = typeof results.significant === 'boolean'
                    ? results.significant
                    : (typeof results.p_value === 'number' ? results.p_value <= alphaVal : false);

                resultTextMw.innerHTML = `
                    <div class="test-result-block">
                        <h4>${results.test_name}</h4>
                        <p>統計量 (${results.stat_name}): <b>${formatNumber(results.stat, 3)}</b></p>
                        <p>P値 (p-value): <b>${formatNumber(results.p_value, 5)}</b></p>
                        <p>有意水準 (α): <b>${formatNumber(alphaVal, 3)}</b></p>
                    </div>
                    <div class="test-result-block">
                        <h4>効果量 (Effect Size)</h4>
                        <p>Z値 (近似): <b>${formatNumber(results.z_approx, 3)}</b></p>
                        <p>効果量 r (r = Z/sqrt(N)): <b>${formatNumber(results.effect_size_r, 3)}</b></p>
                    </div>
                    <hr>
                    ${renderSignificanceMessage(alphaVal, isSignificant)}
                `;
                resultsMw.style.display = 'block';
            } catch (error) {
                alert(`エラー: ${error.message}`);
            } finally {
                spinnerMw.style.display = 'none';
            }
        });

        // 3. ウィルコクソン検定フォーム [修正]
        const formWilcoxon = document.getElementById('form-wilcoxon');
        const spinnerWilcoxon = document.getElementById('spinner-wilcoxon');
        const resultsWilcoxon = document.getElementById('results-wilcoxon');
        const resultTextWilcoxon = document.getElementById('result-text-wilcoxon');
        const alphaWilcoxonInput = document.getElementById('wilcoxon-alpha');

        formWilcoxon.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data1 = document.getElementById('wilcoxon-data1').value;
            const data2 = document.getElementById('wilcoxon-data2').value;
            if (data1.trim() === '' || data2.trim() === '') { alert('2つのグループ両方にデータを入力してください。'); return; }
            spinnerWilcoxon.style.display = 'block';
            resultsWilcoxon.style.display = 'none';

            const formData = new FormData();
            formData.append('data1', data1);
            formData.append('data2', data2);
            formData.append('alternative', document.getElementById('wilcoxon-alternative').value);
            formData.append('alpha', alphaWilcoxonInput ? alphaWilcoxonInput.value || '0.05' : '0.05');

            try {
                const response = await fetch('/analyze-wilcoxon', { method: 'POST', body: formData });
                const results = await response.json();
                if (!response.ok) throw new Error(results.error || 'サーバーエラー');

                const alphaVal = typeof results.alpha === 'number' ? results.alpha : parseFloat(alphaWilcoxonInput?.value || '0.05') || 0.05;
                const isSignificant = typeof results.significant === 'boolean'
                    ? results.significant
                    : (typeof results.p_value === 'number' ? results.p_value <= alphaVal : false);

                resultTextWilcoxon.innerHTML = `
                    <div class="test-result-block">
                        <h4>${results.test_name}</h4>
                        <p>統計量 (${results.stat_name}): <b>${formatNumber(results.stat, 3)}</b></p>
                        <p>P値 (p-value): <b>${formatNumber(results.p_value, 5)}</b></p>
                        <p>有意水準 (α): <b>${formatNumber(alphaVal, 3)}</b></p>
                    </div>
                    <div class="test-result-block">
                        <h4>効果量 (Effect Size)</h4>
                        <p>Z値 (近似): <b>${formatNumber(results.z_approx, 3)}</b></p>
                        <p>効果量 r (r = Z/sqrt(N)): <b>${formatNumber(results.effect_size_r, 3)}</b></p>
                    </div>
                    <hr>
                    ${renderSignificanceMessage(alphaVal, isSignificant)}
                `;
                resultsWilcoxon.style.display = 'block';
            } catch (error) {
                alert(`エラー: ${error.message}`);
            } finally {
                spinnerWilcoxon.style.display = 'none';
            }
        });

        // 4. t検定フォーム [修正]
        const formTTest = document.getElementById('form-ttest');
        const spinnerTTest = document.getElementById('spinner-ttest');
        const resultsTTest = document.getElementById('results-ttest');
        const resultTextTTest = document.getElementById('result-text-ttest');
        const alphaTTestInput = document.getElementById('ttest-alpha');

        // [修正] t検定の結果表示関数を、効果量r, d, df を表示するように書き換え
        function displayTestResult(resultsContainer, resultTextElement, results) {
            const alphaVal = typeof results.alpha === 'number'
                ? results.alpha
                : parseFloat(alphaTTestInput?.value || '0.05') || 0.05;
            const isSignificant = typeof results.significant === 'boolean'
                ? results.significant
                : (typeof results.p_value === 'number' ? results.p_value <= alphaVal : false);

            let html = `
                <div class="test-result-block">
                    <h4>正規性の検定 (Shapiro-Wilk)</h4>
                    <p>Group 1: W = ${formatNumber(results.shapiro1.stat, 4)}, p = ${formatNumber(results.shapiro1.p, 4)}</p>
                    <p>Group 2: W = ${formatNumber(results.shapiro2.stat, 4)}, p = ${formatNumber(results.shapiro2.p, 4)}</p>
                    <p><b>解釈:</b> ${results.normality ? '両群とも正規性を棄却できません (p > 0.05)。' : '<span class="not-significant">少なくとも一方の群が正規性に従いません (p <= 0.05)。</span>'}</p>
                </div>
            `;
            
            // Levene検定の結果 (dfなどと一緒に返ってくる)
            html += `
                <div class="test-result-block">
                    <h4>等分散性の検定 (Levene)</h4>
                    <p>Statistic = ${formatNumber(results.levene.stat, 4)}, p = ${formatNumber(results.levene.p, 4)}</p>
                    <p><b>解釈:</b> ${results.equal_var ? '等分散性を仮定します (p > 0.05)。' : '<span class="not-significant">等分散性を仮定しません (p <= 0.05)。</span>'}</p>
                </div>
            `;

            // t検定の結果
            html += `
                <div class="test-result-block">
                    <h4>${results.test_name}</h4>
                    <p>統計量 (${results.stat_name}): <b>${formatNumber(results.stat, 4)}</b></p>
                    <p>自由度 (df): <b>${formatNumber(results.df, 2)}</b></p>
                    <p>P値 (p-value): <b>${formatNumber(results.p_value, 5)}</b></p>
                    <p>有意水準 (α): <b>${formatNumber(alphaVal, 3)}</b></p>
                </div>
            `;

            // 効果量
            html += `
                <div class="test-result-block">
                    <h4>効果量 (Effect Size)</h4>
                    <p>Cohen's d: <b>${formatNumber(results.effect_size_cohen_d, 3)}</b></p>
                    <p>効果量 r (t-based): <b>${formatNumber(results.effect_size_r, 3)}</b></p>
                </div>
            `;

            // 最終結論
            html += `
                <hr>
                ${renderSignificanceMessage(alphaVal, isSignificant)}
                ${results.message ? `<p><small><i>${results.message}</i></small></p>` : ''}
            `;
            
            resultTextElement.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        formTTest.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data1 = document.getElementById('ttest-data1').value;
            const data2 = document.getElementById('ttest-data2').value;
            if (data1.trim() === '' || data2.trim() === '') { alert('2つのグループ両方にデータを入力してください。'); return; }
            spinnerTTest.style.display = 'block';
            resultsTTest.style.display = 'none';

            const formData = new FormData(formTTest);
            formData.append('data1', data1);
            formData.append('data2', data2);
            formData.append('alternative', document.getElementById('ttest-alternative').value);
            formData.set('alpha', alphaTTestInput ? alphaTTestInput.value || '0.05' : '0.05');

            try {
                const response = await fetch('/analyze-ttest', { method: 'POST', body: formData });
                const results = await response.json();
                if (!response.ok) throw new Error(results.error || 'サーバーエラー');
                
                // 修正された関数で結果を表示
                displayTestResult(resultsTTest, resultTextTTest, results);

            } catch (error) {
                alert(`エラー: ${error.message}`);
            } finally {
                spinnerTTest.style.display = 'none';
            }
        });

        function setupMultipleTestManager({
            testType,
            enableCheckboxId,
            controlsId,
            baseAlphaInputId,
            countInputId,
            formsContainerId,
            copyButtonId,
            runButtonId,
            resultContainerId,
            data1FieldId,
            data2FieldId,
            alternativeFieldId,
            spinnerElement,
            resultsCardElement
        }) {
            const enableCheckbox = document.getElementById(enableCheckboxId);
            const controls = document.getElementById(controlsId);
            const baseAlphaInput = document.getElementById(baseAlphaInputId);
            const countInput = document.getElementById(countInputId);
            const formsContainer = document.getElementById(formsContainerId);
            const copyButton = document.getElementById(copyButtonId);
            const runButton = document.getElementById(runButtonId);
            const resultContainer = document.getElementById(resultContainerId);
            const baseData1Field = document.getElementById(data1FieldId);
            const baseData2Field = document.getElementById(data2FieldId);
            const baseAlternativeField = alternativeFieldId ? document.getElementById(alternativeFieldId) : null;

            if (!enableCheckbox || !controls || !baseAlphaInput || !countInput || !formsContainer || !copyButton || !runButton || !resultContainer || !baseData1Field || !baseData2Field) {
                return;
            }

            const altOptionsHTML = baseAlternativeField ? baseAlternativeField.innerHTML : '';
            const defaultAlternative = baseAlternativeField ? baseAlternativeField.value : 'two-sided';

            const getCount = () => {
                const value = parseInt(countInput.value, 10);
                return Number.isNaN(value) || value < 1 ? 1 : value;
            };

            function createFormBlock(index) {
                const block = document.createElement('div');
                block.className = 'multiple-form-block';
                block.innerHTML = `<h5>テスト ${index + 1}</h5>`;

                const group1 = document.createElement('div');
                group1.className = 'param-group';
                const label1 = document.createElement('label');
                const textarea1 = document.createElement('textarea');
                label1.setAttribute('for', `${formsContainerId}-data1-${index}`);
                label1.textContent = 'Group 1 データ';
                textarea1.id = `${formsContainerId}-data1-${index}`;
                textarea1.rows = 3;
                textarea1.placeholder = '4.1, 4.4, 4.2, ...';
                group1.appendChild(label1);
                group1.appendChild(textarea1);

                const group2 = document.createElement('div');
                group2.className = 'param-group';
                const label2 = document.createElement('label');
                const textarea2 = document.createElement('textarea');
                label2.setAttribute('for', `${formsContainerId}-data2-${index}`);
                label2.textContent = 'Group 2 データ';
                textarea2.id = `${formsContainerId}-data2-${index}`;
                textarea2.rows = 3;
                textarea2.placeholder = '3.5, 3.4, 3.2, ...';
                group2.appendChild(label2);
                group2.appendChild(textarea2);

                block.appendChild(group1);
                block.appendChild(group2);

                if (baseAlternativeField) {
                    const altGroup = document.createElement('div');
                    altGroup.className = 'param-group';
                    const altLabel = document.createElement('label');
                    const altSelect = document.createElement('select');
                    altLabel.setAttribute('for', `${formsContainerId}-alternative-${index}`);
                    altLabel.textContent = '仮説';
                    altSelect.id = `${formsContainerId}-alternative-${index}`;
                    altSelect.innerHTML = altOptionsHTML;
                    altSelect.value = defaultAlternative;
                    altGroup.appendChild(altLabel);
                    altGroup.appendChild(altSelect);
                    block.appendChild(altGroup);
                }

                return block;
            }

            function buildForms() {
                const count = getCount();
                formsContainer.innerHTML = '';
                for (let i = 0; i < count; i += 1) {
                    formsContainer.appendChild(createFormBlock(i));
                }
            }

            function resetMultipleState() {
                formsContainer.innerHTML = '';
                resultContainer.innerHTML = '';
            }

            enableCheckbox.addEventListener('change', () => {
                const enabled = enableCheckbox.checked;
                controls.style.display = enabled ? 'block' : 'none';
                if (enabled) {
                    resultContainer.innerHTML = '';
                    buildForms();
                } else {
                    resetMultipleState();
                }
            });

            countInput.addEventListener('change', () => {
                countInput.value = getCount();
                if (enableCheckbox.checked) {
                    buildForms();
                }
            });

            copyButton.addEventListener('click', () => {
                if (!enableCheckbox.checked) {
                    alert('多重検定を有効にしてください。');
                    return;
                }
                const count = getCount();
                for (let i = 0; i < count; i += 1) {
                    const data1Elem = document.getElementById(`${formsContainerId}-data1-${i}`);
                    const data2Elem = document.getElementById(`${formsContainerId}-data2-${i}`);
                    const altElem = document.getElementById(`${formsContainerId}-alternative-${i}`);
                    if (data1Elem) data1Elem.value = baseData1Field.value;
                    if (data2Elem) data2Elem.value = baseData2Field.value;
                    if (altElem && baseAlternativeField) altElem.value = baseAlternativeField.value;
                }
            });

            runButton.addEventListener('click', async () => {
                if (!enableCheckbox.checked) {
                    alert('多重検定を有効にしてください。');
                    return;
                }

                const alpha = parseFloat(baseAlphaInput.value);
                if (Number.isNaN(alpha) || alpha <= 0 || alpha > 1) {
                    alert('有意水準 (α) には 0 より大きく 1 以下の数値を入力してください。');
                    return;
                }

                const count = getCount();
                const tests = [];

                for (let i = 0; i < count; i += 1) {
                    const data1Elem = document.getElementById(`${formsContainerId}-data1-${i}`);
                    const data2Elem = document.getElementById(`${formsContainerId}-data2-${i}`);
                    const altElem = document.getElementById(`${formsContainerId}-alternative-${i}`);

                    if (!data1Elem || !data2Elem) {
                        alert('多重検定フォームの構成に問題があります。ページを再読み込みしてください。');
                        return;
                    }

                    const data1 = data1Elem.value.trim();
                    const data2 = data2Elem.value.trim();
                    if (!data1 || !data2) {
                        alert(`テスト #${i + 1} のデータを入力してください。`);
                        return;
                    }

                    tests.push({
                        type: testType,
                        data1,
                        data2,
                        alternative: altElem ? altElem.value : 'two-sided'
                    });
                }

                spinnerElement.style.display = 'block';
                resultContainer.innerHTML = '';

                try {
                    const response = await fetch('/analyze-multiple-tests', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tests, alpha })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'サーバーエラー');
                    }

                    let html = '';
                    if (data.correction) {
                        html += `
                            <div class="test-result-block">
                                <h4>Holm-Bonferroni 補正概要</h4>
                                <p>補正方法: <b>${data.correction.method}</b></p>
                                <p>有意水準 (α): <b>${formatNumber(data.correction.alpha, 3)}</b></p>
                            </div>
                        `;
                    }

                    if (Array.isArray(data.tests)) {
                        data.tests.forEach((entry, idx) => {
                            const baseAlpha = typeof entry.result?.alpha === 'number' ? entry.result.alpha : alpha;
                            const baseSignificant = typeof entry.result?.significant === 'boolean'
                                ? entry.result.significant
                                : (typeof entry.result?.p_value === 'number' ? entry.result.p_value <= baseAlpha : false);

                            html += `
                                <div class="test-result-block">
                                    <h4>テスト #${idx + 1}</h4>
                                    <p>結果: ${entry.success ? '<span class="significant">成功</span>' : '<span class="not-significant">失敗</span>'}</p>
                            `;
                            if (entry.success && entry.result) {
                                html += `
                                    <p>統計量 (${entry.result.stat_name || 'stat'}): <b>${formatNumber(entry.result.stat, 4)}</b></p>
                                    <p>p値: <b>${formatNumber(entry.result.p_value, 5)}</b></p>
                                    <p>有意水準 (α): <b>${formatNumber(baseAlpha, 3)}</b></p>
                                    ${renderSignificanceMessage(baseAlpha, baseSignificant)}
                                `;
                                if (entry.result.adjusted_p_value !== undefined) {
                                    html += `<p>Holm補正後 p値: <b>${formatNumber(entry.result.adjusted_p_value, 5)}</b></p>`;
                                }
                                if (entry.result.significant_after_correction !== undefined) {
                                    html += `<p>Holm補正後の有意性: <b>${entry.result.significant_after_correction ? '有意 (True)' : '非有意 (False)'}</b></p>`;
                                }
                            } else if (!entry.success) {
                                html += `<p>エラー: ${entry.error || '不明なエラー'}</p>`;
                            }
                            html += '</div>';
                        });
                    }

                    resultContainer.innerHTML = html || '<p class="muted">有効な結果が返されませんでした。</p>';
                    resultsCardElement.style.display = 'block';
                } catch (error) {
                    alert(`エラー: ${error.message}`);
                } finally {
                    spinnerElement.style.display = 'none';
                }
            });

            if (enableCheckbox.checked) {
                controls.style.display = 'block';
                buildForms();
            }
        }

        setupMultipleTestManager({
            testType: 'mann_whitney',
            enableCheckboxId: 'mw-multiple-enable',
            controlsId: 'mw-multiple-controls',
            baseAlphaInputId: 'mw-alpha',
            countInputId: 'mw-multiple-count',
            formsContainerId: 'mw-multiple-form-container',
            copyButtonId: 'mw-multiple-copy',
            runButtonId: 'mw-multiple-run',
            resultContainerId: 'result-text-mw-multiple',
            data1FieldId: 'mw-data1',
            data2FieldId: 'mw-data2',
            alternativeFieldId: 'mw-alternative',
            spinnerElement: spinnerMw,
            resultsCardElement: resultsMw
        });

        setupMultipleTestManager({
            testType: 'wilcoxon',
            enableCheckboxId: 'wilcoxon-multiple-enable',
            controlsId: 'wilcoxon-multiple-controls',
            baseAlphaInputId: 'wilcoxon-alpha',
            countInputId: 'wilcoxon-multiple-count',
            formsContainerId: 'wilcoxon-multiple-form-container',
            copyButtonId: 'wilcoxon-multiple-copy',
            runButtonId: 'wilcoxon-multiple-run',
            resultContainerId: 'result-text-wilcoxon-multiple',
            data1FieldId: 'wilcoxon-data1',
            data2FieldId: 'wilcoxon-data2',
            alternativeFieldId: 'wilcoxon-alternative',
            spinnerElement: spinnerWilcoxon,
            resultsCardElement: resultsWilcoxon
        });

        setupMultipleTestManager({
            testType: 'ttest',
            enableCheckboxId: 'ttest-multiple-enable',
            controlsId: 'ttest-multiple-controls',
            baseAlphaInputId: 'ttest-alpha',
            countInputId: 'ttest-multiple-count',
            formsContainerId: 'ttest-multiple-form-container',
            copyButtonId: 'ttest-multiple-copy',
            runButtonId: 'ttest-multiple-run',
            resultContainerId: 'result-text-ttest-multiple',
            data1FieldId: 'ttest-data1',
            data2FieldId: 'ttest-data2',
            alternativeFieldId: 'ttest-alternative',
            spinnerElement: spinnerTTest,
            resultsCardElement: resultsTTest
        });
    </script>
</body>
</html>